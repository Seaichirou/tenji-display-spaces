<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>展示ビューア</title>
<link rel="stylesheet" href="style.css">
<body>

<header>
  <div class="header-inner">
    <h1 id="title">展示ビューア</h1>
    <div class="controls" style="margin-left:auto;">
      <a class="btn" href="index.html">展示一覧へ戻る</a>
      <a class="btn warm" href="https://tenji-convert-machine-8fbe49b32604.herokuapp.com/" target="_blank" rel="noopener">変換サイトへ戻る</a>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div id="meta" class="viewer-meta"></div>

    <!-- 文字サイズ（タイプ別に 最大値/初期値 を切替） -->
    <div class="controls" style="margin:8px 0 12px 0;">
      <div class="range">
        <label for="size">文字サイズ</label>
        <input id="size" type="range" min="16" max="30" value="22">
      </div>
    </div>
    <div class="viewer">
      <div id="content">読み込み中…</div>
    </div>
  </div>
</main>

<footer class="footer">© tenji-display-spaces / CC BY-NC 4.0</footer>
<!-- marked.jsをCDNで読み込む -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const qs = new URLSearchParams(location.search);
const id   = qs.get('id');
const type = qs.get('type'); // "墨字" / "6点式" / "8点式" / "備考"
const content = document.getElementById('content');
const size  = document.getElementById('size');

/* 本家アプリと同じ方針：
   - 墨字/点字：pre-wrap（改行は尊重しつつ折り返す）
   - 長い連続文字も折り返せるよう overflow-wrap:anywhere（＋保険 line-break:anywhere）
   - 備考も同じく pre-wrap（読みやすさ優先）
   - フォントサイズ上限はタイプ別（墨字=20.5px, 点字=30px）
*/
const POLICY = {
  "墨字": {
    whiteSpace: "pre-wrap",
    font: 'ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono CJK JP", "Noto Sans Mono", monospace',
    min: 16, max: 20.5, initial: 20.5, step: 0.5,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "6点式": {
    whiteSpace: "pre-wrap",
    font: '"Apple Braille","Noto Sans Symbols2","Segoe UI Symbol", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace',
    min: 20, max: 30, initial: 30, step: 1,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "8点式": {
    whiteSpace: "pre-wrap",
    font: '"Apple Braille","Noto Sans Symbols2","Segoe UI Symbol", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace',
    min: 20, max: 30, initial: 30, step: 1,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "備考": {
    whiteSpace: "pre-wrap",
    font: '',  // 既定フォント
    min: 16, max: 20.5, initial: 20.5, step: 0.5,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  }
};

// viewer.html の部分
async function load() {
  const res = await fetch('manifest.json?v=' + Date.now(), { cache: 'no-cache' });
  const data = await res.json();

  const ex = (data.exhibits || []).find(e => e.id === id);
  const title = document.getElementById('title');
  const meta  = document.getElementById('meta');
  const pre   = document.getElementById('content');
  const size  = document.getElementById('size');

  if (!ex) { pre.textContent = '作品が見つかりません。'; return; }
  const file = ex.files[type];
  if (!file) { pre.textContent = `${type} は用意されていません。`; return; }

  const path = ex.base + file;
  title.textContent = `${ex.label} – ${type}`;  // ここで "6点式" と表示
  meta.textContent  = path.replace('./','/');

  const url = encodeURI(path) + '?v=' + Date.now();
  const txt = await fetch(url, { cache: 'no-cache' }).then(r => r.text());

  // 備考.md の場合はマークダウンをHTMLに変換
  if (type === "備考") {
    // Markdown を HTML に
    content.classList.add('md');
    content.innerHTML = marked.parse(txt);
  } else {
    // テキストそのまま
    content.classList.remove('md');
    content.textContent = txt;
  }

  // スタイル適用対象も content に統一
  const p = POLICY[type] || POLICY["墨字"];
  content.style.whiteSpace = p.whiteSpace;
  content.style.fontFamily = p.font;
  content.style.lineHeight = String(p.lineHeight);
  content.style.letterSpacing = p.letterSpacing;
  content.style.wordSpacing = p.wordSpacing;
  content.style.wordBreak = 'normal';
  content.style.overflowWrap = 'anywhere';
  content.style.lineBreak = 'anywhere';
  content.style.overflowX = 'visible';
  content.style.fontKerning = 'none';
  content.style.fontVariantEastAsian = 'normal';

  // スライダー設定＆反映も content を使う
  size.min = String(p.min);
  size.max = String(p.max);
  size.value = String(p.initial);
  size.step = String(p.step ?? 1);
  applySize();
  size.addEventListener('input', applySize);

  function applySize() {
    content.style.fontSize = size.value + 'px';
  }
}
load();
</script>



</body>
</html>
