<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>展示ビューア</title>
<link rel="stylesheet" href="style.css">
<body>

<header>
  <div class="header-inner">
    <h1 id="title">展示ビューア</h1>
    <div class="controls" style="margin-left:auto;">
      <a class="btn" href="index.html">展示一覧へ戻る</a>
      <a class="btn warm" href="https://tenji-convert-machine-8fbe49b32604.herokuapp.com/" target="_blank" rel="noopener">変換サイトへ戻る</a>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div id="meta" class="viewer-meta"></div>

    <!-- 文字サイズ（タイプ別に 最大値/初期値 を切替） -->
    <div class="controls" style="margin:8px 0 12px 0;">
      <div class="range">
        <label for="size">文字サイズ</label>
        <input id="size" type="range" min="16" max="30" value="22">
        <span id="sizeLabel" class="note" style="margin-left:8px;"></span>
      </div>
    </div>

    <div class="viewer">
      <pre id="content">読み込み中…</pre>
    </div>
  </div>
</main>

<footer class="footer">© tenji-display-spaces / CC BY-NC 4.0</footer>

<script>
const qs = new URLSearchParams(location.search);
const id   = qs.get('id');
const type = qs.get('type'); // "墨字" / "6点式点字" / "8点式点字" / "備考"

// タイプ別ポリシー（40文字行を守る：墨字/点字は改行のみ、備考は折り返し）
const POLICY = {
  "墨字": {
    whiteSpace: "pre-wrap",
    font: '',
    min: 16, max: 21, initial: 21,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "6点式点字": {
    whiteSpace: "pre",
    font: '"Apple Braille","Noto Sans Symbols2","Segoe UI Symbol", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace',
    min: 20, max: 34, initial: 30,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "8点式点字": {
    whiteSpace: "pre",
    font: '"Apple Braille","Noto Sans Symbols2","Segoe UI Symbol", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace',
    min: 20, max: 34, initial: 30,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  },
  "備考": {
    whiteSpace: "pre-wrap", // 備考は通常の折返し
    font: '',               // 既定フォント
    min: 16, max: 21, initial: 21,
    lineHeight: 2.0, letterSpacing: "0", wordSpacing: "0"
  }
};

async function load() {
  // manifest 読み込み（キャッシュ回避）
  const res = await fetch('manifest.json?v=' + Date.now(), { cache: 'no-cache' });
  const data = await res.json();

  const ex = (data.exhibits || []).find(e => e.id === id);
  const title = document.getElementById('title');
  const meta  = document.getElementById('meta');
  const pre   = document.getElementById('content');
  const size  = document.getElementById('size');
  const sizeLabel = document.getElementById('sizeLabel');

  if (!ex) { pre.textContent = '作品が見つかりません。'; return; }
  const file = ex.files[type];
  if (!file) { pre.textContent = `${type} は用意されていません。`; return; }

  const path = ex.base + file;
  title.textContent = `${ex.label} – ${type}`;
  meta.textContent  = path.replace('./','/');

  // 本文（日本語パス + キャッシュ回避）
  const url = encodeURI(path) + '?v=' + Date.now();
  const txt = await fetch(url, { cache: 'no-cache' }).then(r => r.text());
  pre.textContent = txt;

  // タイプ別適用
  const p = POLICY[type] || POLICY["墨字"];
  pre.style.whiteSpace   = p.whiteSpace;
  pre.style.fontFamily   = p.font;
  pre.style.lineHeight   = String(p.lineHeight);
  pre.style.letterSpacing= p.letterSpacing;
  pre.style.wordSpacing  = p.wordSpacing;

  // 点字/墨字はみ出し時の横スクロール（改行厳守）
  pre.style.overflowX = (type === '備考') ? 'visible' : 'auto';

  // 幅ブレ抑制
  pre.style.fontKerning  = 'none';
  pre.style.fontVariantEastAsian = 'normal';

  // スライダ設定（タイプ別レンジ）
  size.min = String(p.min);
  size.max = String(p.max);
  size.value = String(p.initial);
  applySize();
  size.addEventListener('input', applySize);

  function applySize() {
    pre.style.fontSize = size.value + 'px';
    sizeLabel.textContent = size.value + 'px';
  }
}
load();
</script>

</body>
</html>
